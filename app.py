import streamlit as st
import os
from google.adk.client import Client

# -----------------------------------------------
# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
# -----------------------------------------------

st.set_page_config(page_title="ÙˆÙƒÙŠÙ„ Ù…Ø·Ø¹Ù… Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø°ÙƒÙŠ", layout="wide")
st.title("ğŸ” ÙˆÙƒÙŠÙ„ Ù…Ø·Ø¹Ù… Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø°ÙƒÙŠ (ADK)")
st.caption("ÙŠØªÙ„Ù‚Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆÙŠØ­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Gemini Agent.")

# -----------------------------------------------
# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ÙØªØ§Ø­ API
# -----------------------------------------------

# ÙŠØ¬Ø¨ ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ API ÙƒÙ…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© Ù„Ù„Ù†Ø´Ø± Ø§Ù„Ø¢Ù…Ù†
if 'GEMINI_API_KEY' not in os.environ:
    st.error("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ Gemini API ÙƒÙ…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„.")
    st.stop()

# -----------------------------------------------
# ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ÙˆÙƒÙŠÙ„
# -----------------------------------------------

def run_agent_interaction(user_input):
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ ADK ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¯ÙÙ‚
        client = Client(config_path="config.yaml")

        # ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (default flow)
        # Ù†Ø±Ø³Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Flow (Client -> Restaurant)
        response = client.flow_run("default", user_input)

        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ù† ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø·Ø¹Ù…
        if response and response.messages:
            # Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù‡ÙŠ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø·Ø¹Ù…
            final_message = response.messages[-1].content
            return final_message
        else:
            return "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ„Ù‚ Ø±Ø¯Ø§Ù‹ ÙˆØ§Ø¶Ø­Ø§Ù‹ Ù…Ù† ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø·Ø¹Ù…."

    except Exception as e:
        # Ø¹Ø±Ø¶ Ø£ÙŠ Ø£Ø®Ø·Ø§Ø¡ ØªØ­Ø¯Ø« ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„
        return f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„: {e}"

# -----------------------------------------------
# ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Streamlit UI)
# -----------------------------------------------

# Ù…Ø±Ø¨Ø¹ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
user_prompt = st.text_input("Ø£Ø¯Ø®Ù„ Ø·Ù„Ø¨Ùƒ (Ù…Ø«Ø§Ù„: Ø£Ø±ÙŠØ¯ 2 Ø¨Ø±Ø¬Ø± Ùˆ 1 Ø¨ÙŠØªØ²Ø§):", key="user_input")

if user_prompt:
    with st.spinner('ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨ÙˆØ§Ø³Ø·Ø© ÙˆÙƒÙ„Ø§Ø¡ Gemini...'):
        # ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆÙƒÙŠÙ„ ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯
        agent_response = run_agent_interaction(user_prompt)

        # Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¯
        st.subheader("ğŸ½ï¸ Ø±Ø¯ ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø·Ø¹Ù…:")
        st.info(agent_response)